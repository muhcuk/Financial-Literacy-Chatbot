# =================================================================
#      FLASK CHATBOT - SETUP & RUN SCRIPT
# =================================================================
$ErrorActionPreference = 'Stop'
Write-Host "üöÄ Starting the Flask Chatbot Setup..."

# 1. Create/Check Virtual Environment
if (-not (Test-Path -Path ".\venv")) {
    Write-Host "   - Setting up Python virtual environment..."
    python -m venv venv
}
Write-Host "   - Activating virtual environment..."
# Note: Activation is for this script's session
& ".\venv\Scripts\Activate.ps1"

# 2. Install Dependencies
Write-Host "   - Installing dependencies from requirements_flask.txt..."
& ".\venv\Scripts\pip.exe" install -r requirements_flask.txt

# 3. Check for Ollama Model
Write-Host "   - Checking for Ollama and Llama 3 model..."
$ollamaExists = Get-Command ollama -ErrorAction SilentlyContinue
if (-not $ollamaExists) {
    Write-Host "‚ùå Error: Ollama is not installed." -ForegroundColor Red; exit 1
}
try {
    $ollamaList = ollama list
    $modelToUse = "llama3:8b:q4_K_M"
    if ($ollamaList -match $modelToUse) {
        Write-Host "‚úÖ Model '$modelToUse' is already installed." -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è  Model '$modelToUse' not found. Pulling it now..." -ForegroundColor Yellow
        ollama pull $modelToUse
    }
} catch {
    Write-Host "‚ö†Ô∏è  Warning: Cannot connect to Ollama." -ForegroundColor Yellow
}

Write-Host "`n‚úÖ Flask Setup Complete!" -ForegroundColor Green
Write-Host "--------------------------------------------------------"
Write-Host "Launching the Flask application..."
Write-Host "Make sure your database is built (run database_build.py in the data_pipeline folder)."
Write-Host "Open your browser to http://127.0.0.1:5000"
& ".\venv\Scripts\python.exe" run_chatbot_app.py